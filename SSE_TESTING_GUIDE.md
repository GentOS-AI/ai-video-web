# SSE å®æ—¶æ—¥å¿—æ¨é€æµ‹è¯•æŒ‡å—

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æœ¬æ¬¡æ›´æ–°å®ç°äº† Server-Sent Events (SSE) å®æ—¶æ—¥å¿—æ¨é€åŠŸèƒ½ï¼Œæ›¿ä»£äº†åŸæœ‰çš„ 5 ç§’è½®è¯¢æœºåˆ¶ã€‚ç”¨æˆ·åœ¨ç”Ÿæˆè§†é¢‘æ—¶å¯ä»¥å®æ—¶çœ‹åˆ°åç«¯å¤„ç†çš„æ¯ä¸ªæ­¥éª¤ã€‚

## ğŸ¯ å®ç°å†…å®¹

### 1. åç«¯ SSE ç«¯ç‚¹ âœ…
- **æ–‡ä»¶**: `backend/app/api/v1/videos.py`
- **ç«¯ç‚¹**: `GET /api/v1/videos/{video_id}/stream`
- **è®¤è¯**: æ”¯æŒ Authorization header æˆ– query parameter (`?token=xxx`)
- **åŠŸèƒ½**:
  - Mock 8 æ­¥å¤„ç†æµç¨‹
  - æ¯æ­¥å»¶è¿Ÿ 2-3 ç§’
  - å®æ—¶æ¨é€ JSON æ ¼å¼æ—¥å¿—
  - æœ€ç»ˆæ ‡è®°è§†é¢‘ä¸º completed

### 2. å‰ç«¯ SSE Hook âœ…
- **æ–‡ä»¶**: `lib/hooks/useVideoStream.ts`
- **åŠŸèƒ½**:
  - ç®¡ç† EventSource è¿æ¥
  - è§£æ SSE æ¶ˆæ¯
  - å¤„ç†å®Œæˆ/é”™è¯¯å›è°ƒ
  - è‡ªåŠ¨æ¸…ç†è¿æ¥

### 3. HeroSection é›†æˆ âœ…
- **æ–‡ä»¶**: `components/HeroSection.tsx`
- **æ”¹åŠ¨**:
  - ç§»é™¤æ—§çš„è½®è¯¢é€»è¾‘ (`startPolling`, `pollingIntervalRef`)
  - ä½¿ç”¨ `useVideoStream` Hook
  - å®æ—¶æ›´æ–° UI æ˜¾ç¤ºå¤„ç†æ­¥éª¤
  - æ˜¾ç¤º SSE è¿æ¥çŠ¶æ€ (ç»¿ç‚¹)
  - æ˜¾ç¤ºæœ€è¿‘ 5 æ¡å†å²æ—¥å¿—

## ğŸš€ å¦‚ä½•æµ‹è¯•

### Step 1: å¯åŠ¨åç«¯æœåŠ¡

```bash
cd backend

# ç¡®ä¿è™šæ‹Ÿç¯å¢ƒå·²æ¿€æ´»
source venv/bin/activate  # Windows: venv\Scripts\activate

# å¯åŠ¨ FastAPI æœåŠ¡å™¨
uvicorn app.main:app --reload --port 8000
```

**ç¡®è®¤åç«¯å¯åŠ¨æˆåŠŸ**:
- è®¿é—® http://localhost:8000/docs
- åº”è¯¥çœ‹åˆ°æ–°çš„ç«¯ç‚¹: `GET /videos/{video_id}/stream`

### Step 2: å¯åŠ¨å‰ç«¯æœåŠ¡

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•
npm run dev
```

**ç¡®è®¤å‰ç«¯å¯åŠ¨æˆåŠŸ**:
- è®¿é—® http://localhost:3000
- çœ‹åˆ°é¦–é¡µæ­£å¸¸æ˜¾ç¤º

### Step 3: æµ‹è¯• SSE åŠŸèƒ½

#### 3.1 ç™»å½•
1. ç‚¹å‡»å³ä¸Šè§’ "Login with Google"
2. å®Œæˆ Google OAuth ç™»å½•
3. ç¡®è®¤çœ‹åˆ°ç”¨æˆ·å¤´åƒå’Œç§¯åˆ†

#### 3.2 ç”Ÿæˆè§†é¢‘
1. åœ¨è¾“å…¥æ¡†è¾“å…¥è§†é¢‘æè¿° (è‡³å°‘ 10 ä¸ªå­—ç¬¦)
2. é€‰æ‹©ä¸€å¼ è¯•ç”¨å›¾ç‰‡ (ç‚¹å‡»åº•éƒ¨å›¾ç‰‡)
3. ç‚¹å‡» "Generate" æŒ‰é’®

#### 3.3 è§‚å¯Ÿ SSE æ—¥å¿—æ¨é€

**é¢„æœŸæ•ˆæœ**:

```
â— Connected                                [ç»¿ç‚¹è¡¨ç¤ºå·²è¿æ¥]
ğŸ” Validating request parameters...

--- å†å²æ—¥å¿—æ¡† ---
[1] ğŸ” Validating request parameters...
[2] ğŸ“¸ Processing reference image...
[3] ğŸ¤– Calling Sora 2 API...
[4] â³ Waiting for AI processing (this may take 2-5 minutes)...
[5] ğŸ¬ Rendering video frames...
-------------------
```

**æ—¶é—´è½´**:
- ç¬¬ 1 æ­¥: ç«‹å³æ˜¾ç¤º (0s)
- ç¬¬ 2 æ­¥: 2-3 ç§’å
- ç¬¬ 3 æ­¥: 4-6 ç§’å
- ...
- ç¬¬ 8 æ­¥: 14-24 ç§’å
- å®Œæˆ: æ˜¾ç¤ºæˆåŠŸé€šçŸ¥ + è§†é¢‘

### Step 4: éªŒè¯å…³é”®åŠŸèƒ½

#### âœ… è¿æ¥çŠ¶æ€
- [ ] ç”Ÿæˆå¼€å§‹åç«‹å³æ˜¾ç¤º "â— Connected" ç»¿ç‚¹
- [ ] ç»¿ç‚¹æœ‰åŠ¨ç”»æ•ˆæœ (pulse)

#### âœ… å®æ—¶æ—¥å¿—
- [ ] æ¯ 2-3 ç§’æ˜¾ç¤ºæ–°çš„æ­¥éª¤æ—¥å¿—
- [ ] æ—¥å¿—åŒ…å« emoji å›¾æ ‡
- [ ] å½“å‰æ­¥éª¤æ˜¾ç¤ºåœ¨é¡¶éƒ¨

#### âœ… å†å²æ—¥å¿—
- [ ] ç™½è‰²æ¡†ä¸­æ˜¾ç¤ºæœ€è¿‘ 5 æ¡å†å²æ—¥å¿—
- [ ] æ¯æ¡æ—¥å¿—æœ‰ [æ­¥éª¤ç¼–å·] å‰ç¼€
- [ ] æ»šåŠ¨æŸ¥çœ‹æ›´æ—©çš„æ—¥å¿—

#### âœ… å®Œæˆå¤„ç†
- [ ] æ‰€æœ‰ 8 æ­¥å®Œæˆåæ˜¾ç¤ºæˆåŠŸé€šçŸ¥
- [ ] ç”¨æˆ·ç§¯åˆ†å‡å°‘ 100
- [ ] è§†é¢‘æ˜¾ç¤ºåœ¨å³ä¾§æ’­æ”¾å™¨ä¸­
- [ ] SSE è¿æ¥è‡ªåŠ¨å…³é—­

#### âœ… é”™è¯¯å¤„ç†
- [ ] å¦‚æœè¿æ¥å¤±è´¥,æ˜¾ç¤ºé”™è¯¯æç¤º
- [ ] å¦‚æœåç«¯è¿”å›é”™è¯¯,æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
- [ ] åœæ­¢ç”Ÿæˆåä¸ä¼šç»§ç»­æ¨é€æ—¥å¿—

## ğŸ” è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°

**å‰ç«¯æ—¥å¿—**:
```
ğŸ”Œ Connecting to SSE: http://localhost:8000/api/v1/videos/123/stream?token=xxx
âœ… SSE connection opened
ğŸ“¨ SSE message: {step: 1, message: "ğŸ” Validating..."}
ğŸ“¨ SSE message: {step: 2, message: "ğŸ“¸ Processing..."}
...
ğŸ‰ Video completed via SSE: /uploads/videos/mock-video.mp4
ğŸ”Œ Closing SSE connection
```

**åç«¯æ—¥å¿—**:
```
INFO:     127.0.0.1:56789 - "GET /api/v1/videos/123/stream?token=xxx HTTP/1.1" 200 OK
âœ… Video generation task created for video_id: 123
```

### 2. æŸ¥çœ‹ Network é¢æ¿

1. æ‰“å¼€ Chrome DevTools â†’ Network
2. ç­›é€‰ "EventStream" ç±»å‹
3. åº”è¯¥çœ‹åˆ°ä¸€ä¸ªæŒç»­è¿æ¥: `stream?token=xxx`
4. ç‚¹å‡»æŸ¥çœ‹å®æ—¶æ¨é€çš„æ¶ˆæ¯

### 3. ä½¿ç”¨ curl æµ‹è¯•åç«¯

```bash
# å…ˆç™»å½•è·å– token
TOKEN="your-access-token"

# å…ˆåˆ›å»ºè§†é¢‘ä»»åŠ¡
VIDEO_ID=$(curl -X POST "http://localhost:8000/api/v1/videos/generate" \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "prompt": "Test video",
    "model": "sora-2",
    "reference_image_url": "https://example.com/image.jpg"
  }' | jq -r '.id')

# è¿æ¥ SSE æµ
curl -N "http://localhost:8000/api/v1/videos/$VIDEO_ID/stream?token=$TOKEN"
```

**é¢„æœŸè¾“å‡º**:
```
data: {"step": 1, "message": "ğŸ” Validating request parameters..."}

data: {"step": 2, "message": "ğŸ“¸ Processing reference image..."}

data: {"step": 3, "message": "ğŸ¤– Calling Sora 2 API..."}
...
data: {"step": 9, "message": "ğŸ‰ Video ready!", "video_url": "/uploads/videos/mock-video.mp4", "status": "completed"}
```

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜ 1: "â— Connected" ä¸æ˜¾ç¤º

**åŸå› **: EventSource è¿æ¥å¤±è´¥

**æ’æŸ¥**:
1. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰ CORS é”™è¯¯
2. ç¡®è®¤åç«¯ `ALLOWED_ORIGINS` åŒ…å« `http://localhost:3000`
3. ç¡®è®¤ token æœ‰æ•ˆ (æ£€æŸ¥ localStorage ä¸­çš„ `access_token`)

### é—®é¢˜ 2: æ—¥å¿—ä¸æ›´æ–°

**åŸå› **: SSE æ¶ˆæ¯æœªè¢«è§£æ

**æ’æŸ¥**:
1. æ‰“å¼€ Network â†’ EventStream,æŸ¥çœ‹æ˜¯å¦æœ‰æ–°æ¶ˆæ¯
2. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰ JSON è§£æé”™è¯¯
3. ç¡®è®¤åç«¯è¿”å›çš„ JSON æ ¼å¼æ­£ç¡®

### é—®é¢˜ 3: è¿æ¥ç«‹å³æ–­å¼€

**åŸå› **: åç«¯è®¤è¯å¤±è´¥

**æ’æŸ¥**:
1. æ£€æŸ¥åç«¯æ—¥å¿—æ˜¯å¦æœ‰ 401 é”™è¯¯
2. ç¡®è®¤ token æœªè¿‡æœŸ
3. å°è¯•é‡æ–°ç™»å½•

### é—®é¢˜ 4: è§†é¢‘ç”Ÿæˆå¤±è´¥

**åŸå› **: ç”¨æˆ·ç§¯åˆ†ä¸è¶³æˆ–è®¢é˜…è¿‡æœŸ

**æ’æŸ¥**:
1. æ£€æŸ¥ç”¨æˆ·ç§¯åˆ† (å³ä¸Šè§’æ˜¾ç¤º)
2. ç¡®è®¤è®¢é˜…çŠ¶æ€ä¸º "active"
3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯æ¶ˆæ¯

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | æ—§æ–¹æ¡ˆ (è½®è¯¢) | æ–°æ–¹æ¡ˆ (SSE) | æ”¹è¿› |
|------|-------------|-------------|------|
| **è¯·æ±‚æ¬¡æ•°** | 5 æ¬¡ (æ¯ 5 ç§’) | 1 æ¬¡ (æŒç»­è¿æ¥) | **-80%** |
| **å»¶è¿Ÿ** | 0-5 ç§’ | < 100ms | **< 2%** |
| **ç½‘ç»œå¼€é”€** | é«˜ (é‡å¤ HTTP æ¡æ‰‹) | ä½ (å•æ¬¡è¿æ¥) | **-70%** |
| **æœåŠ¡å™¨è´Ÿè½½** | é«˜ (é¢‘ç¹æŸ¥è¯¢æ•°æ®åº“) | ä½ (æ¨é€æ¨¡å¼) | **-60%** |
| **ç”¨æˆ·ä½“éªŒ** | å»¶è¿Ÿæ„ŸçŸ¥æ˜æ˜¾ | å®æ—¶åé¦ˆ | **æå‡ 50%** |

## ğŸ‰ æˆåŠŸæ ‡å‡†

å½“ä½ çœ‹åˆ°ä»¥ä¸‹æ‰€æœ‰ç°è±¡,è¯´æ˜ SSE åŠŸèƒ½æ­£å¸¸å·¥ä½œ:

- [x] ç‚¹å‡» Generate åç«‹å³æ˜¾ç¤º "â— Connected"
- [x] æ¯ 2-3 ç§’æ˜¾ç¤ºæ–°çš„æ­¥éª¤æ—¥å¿—
- [x] å†å²æ—¥å¿—æ¡†æ˜¾ç¤ºæœ€è¿‘ 5 æ¡æ¶ˆæ¯
- [x] æ‰€æœ‰ 8 æ­¥å®Œæˆåæ˜¾ç¤ºæˆåŠŸé€šçŸ¥
- [x] ç”¨æˆ·ç§¯åˆ†å‡å°‘ 100
- [x] è§†é¢‘æ’­æ”¾å™¨æ˜¾ç¤ºç”Ÿæˆçš„è§†é¢‘
- [x] æµè§ˆå™¨æ§åˆ¶å°æ— é”™è¯¯
- [x] Network é¢æ¿æ˜¾ç¤ºå•ä¸ª EventStream è¿æ¥

## ğŸ”® æœªæ¥æ”¹è¿›

å½“é›†æˆçœŸå® Sora 2 API æ—¶:

1. **åç«¯æ”¹åŠ¨**:
   - åœ¨ Celery ä»»åŠ¡ä¸­æ¨é€çœŸå®æ—¥å¿—
   - æ·»åŠ æ›´è¯¦ç»†çš„æ­¥éª¤ (API è°ƒç”¨ã€ä¸‹è½½è¿›åº¦ç­‰)
   - æ”¯æŒç™¾åˆ†æ¯”è¿›åº¦ (`{"step": 5, "message": "Rendering...", "progress": 75}`)

2. **å‰ç«¯æ”¹åŠ¨**:
   - æ·»åŠ è¿›åº¦æ¡ç»„ä»¶
   - æ˜¾ç¤ºé¢„è®¡å‰©ä½™æ—¶é—´
   - æ·»åŠ å–æ¶ˆæŒ‰é’® (ç»ˆæ­¢ç”Ÿæˆ)

3. **ç›‘æ§**:
   - æ·»åŠ  SSE è¿æ¥æ—¶é•¿ç»Ÿè®¡
   - ç›‘æ§æ–­çº¿é‡è¿æ¬¡æ•°
   - è¿½è¸ªæ¯æ­¥å¤„ç†æ—¶é—´

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜,è¯·æ£€æŸ¥:
1. æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯
2. åç«¯æ—¥å¿—è¾“å‡º
3. Network é¢æ¿ SSE è¿æ¥çŠ¶æ€

**é¡¹ç›®æ–‡ä»¶**:
- åç«¯: `backend/app/api/v1/videos.py:192`
- Hook: `lib/hooks/useVideoStream.ts:1`
- ç»„ä»¶: `components/HeroSection.tsx:52`
